import os
import sys
import logging
import datetime
import uuid

from svglib.svglib import svg2rlg
from svglib.svglib import SvgRenderer
from reportlab.graphics import renderPM

logger = None


def get_logger(ctx):

    global logger

    if logger is None:
        output_file_handler = logging.FileHandler(f"{datetime.date.today().strftime('%d-%m-%Y')}.log")
        stdout_handler = logging.StreamHandler(sys.stdout)
        logging.basicConfig(format='%(asctime)s - %(message)s')
        logging.root.setLevel(logging.INFO)
        logger = logging.getLogger(ctx)
        logger.addHandler(output_file_handler)
        logger.addHandler(stdout_handler)

    return logger


def svg_to_png(svg_str) -> str:
    # svg_str = '<svg xmlns="http://www.w3.org/2000/svg" width="150" height="50" viewBox="0,0,150,50"><path d="M17 20 C93 11,58 10,147 33" stroke="#555" fill="none"/><path d="M9 39 C70 9,77 37,131 43" stroke="#555" fill="none"/><path d="M18 31 C70 28,55 12,133 23" stroke="#444" fill="none"/><path fill="#111" d="M68.31 19.33L68.41 19.43L68.41 19.42Q69.19 23.60 69.35 27.18L69.38 27.21L69.37 27.21Q70.48 27.29 71.55 27.29L71.46 27.20L73.62 27.16L73.70 27.23Q74.67 27.14 75.55 25.73L75.54 25.72L75.65 25.83Q76.40 24.68 76.51 23.50L76.44 23.43L76.43 23.42Q76.88 20.47 72.65 19.98L72.56 19.89L72.63 19.96Q70.90 19.86 68.27 19.29ZM69.42 29.99L69.40 29.98L69.38 29.96Q69.36 36.22 68.22 40.63L68.09 40.50L68.11 40.53Q66.79 41.07 64.47 42.14L64.29 41.96L64.45 42.12Q66.68 35.33 66.41 28.06L66.57 28.21L66.55 28.19Q66.22 20.78 63.44 14.35L63.37 14.27L63.37 14.27Q67.56 17.09 73.80 17.09L73.88 17.17L73.86 17.15Q79.87 17.11 80.02 20.57L80.05 20.60L80.01 20.56Q80.05 22.97 79.06 25.63L79.00 25.56L79.04 25.60Q78.65 26.74 77.70 27.96L77.67 27.93L77.63 27.89Q76.35 29.54 73.80 29.81L73.79 29.79L73.78 29.78Q71.68 29.97 69.44 30.01ZM75.51 32.20L75.48 32.17L75.50 32.19Q79.75 32.52 81.00 27.72L80.84 27.56L80.91 27.63Q81.88 23.99 81.72 21.97L81.72 21.97L81.77 22.02Q81.50 20.34 80.74 19.35L80.82 19.42L80.74 19.35Q80.48 19.09 79.98 18.86L79.95 18.83L80.08 18.95Q79.98 18.71 79.38 17.95L79.34 17.91L79.32 17.89Q77.91 16.70 73.95 16.70L73.92 16.68L73.96 16.72Q66.99 16.64 62.76 13.48L62.67 13.39L62.65 13.37Q65.95 20.58 66.22 28.05L66.19 28.02L66.26 28.10Q66.55 35.77 63.89 42.85L63.86 42.82L63.85 42.82Q64.80 42.05 65.79 41.67L65.91 41.79L65.43 42.83L65.53 42.93Q65.26 43.42 64.99 43.99L64.99 43.99L65.06 44.06Q67.38 42.92 70.28 42.38L70.36 42.47L70.33 42.44Q71.14 36.89 71.21 32.17L71.19 32.14L71.34 32.29Q72.41 32.18 73.40 32.18L73.45 32.24L73.39 32.18Q74.64 32.09 75.43 32.13ZM74.57 22.27L74.50 22.21L74.51 22.21Q75.00 22.21 75.99 22.44L75.99 22.44L75.98 22.43Q76.06 22.63 76.10 22.93L76.13 22.96L76.15 22.98Q76.15 23.21 76.08 23.48L76.17 23.58L76.06 23.46Q76.13 24.87 75.41 25.74L75.25 25.59L75.40 25.73Q74.79 26.76 73.76 26.95L73.71 26.90L73.68 26.87Q72.90 26.81 71.26 26.81L71.36 26.91L71.29 26.84Q71.24 24.54 71.01 22.18L71.03 22.20L72.72 22.21L72.74 22.23Q73.59 22.25 74.47 22.18Z"/><path fill="#333" d="M124.67 30.85L124.73 30.91L124.81 30.98Q124.80 29.46 123.98 28.54L123.90 28.46L123.93 28.49Q123.21 27.67 121.76 27.71L121.73 27.68L121.65 27.60Q119.45 27.80 118.61 29.93L118.60 29.92L118.63 29.95Q118.26 30.64 118.22 31.33L118.29 31.39L118.26 31.37Q118.03 36.20 117.11 40.54L117.15 40.57L117.20 40.62Q115.34 40.97 113.47 41.96L113.50 41.98L113.49 41.97Q115.85 35.09 115.59 27.78L115.59 27.78L115.49 27.69Q115.22 20.33 112.67 13.52L112.81 13.66L112.73 13.58Q114.51 14.90 116.53 15.59L116.45 15.51L116.56 15.62Q117.89 21.29 118.08 27.15L118.25 27.32L118.11 27.18Q119.66 25.26 122.36 25.34L122.24 25.22L122.23 25.21Q127.36 25.36 127.48 30.72L127.54 30.79L127.44 30.69Q127.55 36.36 128.92 41.00L128.90 40.98L129.05 41.13Q127.21 40.32 125.46 40.13L125.42 40.09L125.44 40.11Q124.81 36.73 124.69 30.87ZM125.12 40.43L124.96 40.27L125.07 40.38Q126.10 40.50 127.20 40.76L127.11 40.68L127.22 40.79Q127.28 40.96 127.81 42.94L127.79 42.91L127.76 42.89Q130.66 43.76 132.67 45.21L132.72 45.26L132.81 45.35Q130.10 39.55 129.57 33.23L129.57 33.23L129.57 33.23Q129.17 29.45 127.77 27.89L127.78 27.91L127.81 27.94Q127.87 27.92 127.22 27.46L127.03 27.27L127.11 27.34Q126.94 26.91 126.29 26.15L126.28 26.14L126.26 26.04L126.33 26.12Q125.37 25.15 122.25 24.89L122.31 24.95L122.25 24.89Q121.54 24.90 120.13 25.25L120.08 25.20L120.15 25.26Q119.87 20.33 119.52 17.82L119.59 17.89L119.65 17.95Q118.73 17.68 117.25 17.37L117.35 17.47L117.36 17.48Q117.22 16.77 116.95 15.29L116.92 15.26L116.91 15.24Q114.02 14.33 112.15 12.77L112.14 12.75L112.05 12.67Q115.06 19.86 115.32 27.67L115.34 27.68L115.23 27.58Q115.50 35.34 112.94 42.69L113.11 42.85L113.02 42.76Q114.00 42.22 115.14 41.72L115.10 41.68L114.43 44.02L114.38 43.97Q117.55 42.68 119.53 42.49L119.38 42.35L119.41 42.38Q120.09 37.08 120.28 33.12L120.21 33.05L120.27 33.11Q120.39 31.29 122.33 30.19L122.35 30.20L122.26 30.12Q122.85 29.94 123.38 29.98L123.39 29.99L123.23 29.82Q123.50 29.95 123.84 29.98L123.81 29.95L124.35 30.15L124.36 30.16Q124.20 30.37 124.31 30.83L124.37 30.89L124.31 30.83Q124.50 36.89 125.00 40.31Z"/><path fill="#222" d="M93.14 40.42L93.03 40.30L93.03 40.30Q88.99 40.56 88.00 38.24L88.04 38.28L88.10 38.35Q88.86 37.39 90.42 35.60L90.34 35.51L90.36 35.54Q90.89 37.59 93.90 37.71L93.89 37.69L93.86 37.66Q97.19 37.68 98.83 36.35L98.89 36.41L98.99 36.51Q100.38 34.90 100.31 32.20L100.14 32.03L100.32 32.21Q100.13 27.11 95.33 27.34L95.23 27.24L95.27 27.28Q92.48 27.46 90.73 28.72L90.74 28.72L90.31 28.44L90.14 28.35L90.19 28.40Q90.52 25.23 90.41 22.49L90.38 22.46L90.42 22.51Q90.38 19.95 90.04 16.64L89.93 16.53L89.96 16.56Q93.69 17.59 97.50 17.47L97.31 17.29L97.37 17.34Q101.15 17.24 104.73 15.99L104.82 16.08L104.29 17.64L104.19 17.54Q103.91 18.32 103.72 19.16L103.64 19.08L103.67 19.12Q100.70 20.30 96.82 20.30L96.77 20.24L96.67 20.14Q95.30 20.22 93.81 20.07L93.75 20.00L93.84 20.09Q93.64 20.66 93.29 25.11L93.40 25.22L93.31 25.13Q94.12 24.64 96.18 24.49L96.28 24.59L96.18 24.49Q99.98 24.79 101.43 26.47L101.36 26.40L101.38 26.41Q102.82 28.01 103.09 31.86L103.05 31.82L103.01 31.78Q103.34 36.04 102.13 38.05L102.22 38.14L102.06 37.99Q100.03 39.88 96.72 40.11L96.74 40.12L96.76 40.15Q95.85 40.31 93.19 40.46ZM99.08 42.58L99.21 42.71L99.06 42.56Q102.54 42.69 104.44 41.59L104.50 41.65L104.54 41.69Q105.39 40.02 105.39 37.93L105.56 38.10L105.45 37.99Q105.41 34.87 104.46 30.75L104.49 30.79L104.60 30.90Q104.16 29.08 102.94 27.67L103.02 27.76L103.01 27.78L102.78 27.48L102.43 27.28L102.45 27.30Q102.12 26.55 101.47 25.86L101.36 25.75L101.40 25.83L101.40 25.83Q100.01 24.29 96.32 24.29L96.28 24.25L95.90 24.14L95.99 24.23Q96.13 23.72 96.32 22.62L96.15 22.45L96.30 22.59Q101.17 22.59 105.20 20.95L105.34 21.09L105.34 21.09Q105.67 19.60 106.63 16.78L106.70 16.85L104.45 17.65L104.51 17.71Q105.00 16.68 105.50 15.54L105.32 15.36L105.31 15.35Q101.65 16.98 97.54 17.06L97.37 16.89L97.37 16.89Q93.29 17.03 89.33 15.93L89.34 15.94L89.47 16.07Q90.09 20.42 90.09 24.84L90.06 24.81L90.09 24.84Q90.16 26.81 90.05 28.71L89.96 28.63L89.89 28.55Q90.31 28.90 90.88 29.21L90.72 29.04L90.88 29.21Q91.11 28.87 91.76 28.52L91.78 28.55L91.70 28.46Q91.75 29.31 91.52 30.83L91.58 30.89L91.53 30.85Q91.98 31.07 92.40 31.30L92.27 31.16L92.29 31.18Q95.08 29.44 96.94 29.44L96.97 29.47L96.99 29.50Q98.33 29.50 99.51 30.15L99.55 30.18L99.51 30.14Q99.77 31.09 99.80 32.04L99.93 32.16L99.93 32.17Q100.06 34.81 99.03 35.91L98.83 35.71L98.94 35.82Q97.58 37.04 95.33 37.27L95.24 37.18L95.38 37.32Q94.39 37.36 93.71 37.29L93.59 37.17L93.62 37.20Q92.88 37.19 92.12 36.84L92.02 36.74L92.06 36.60L91.95 36.71L91.91 36.67Q91.21 36.27 90.67 34.94L90.50 34.76L90.65 34.91Q89.34 36.35 87.67 38.48L87.50 38.31L87.65 38.46Q87.93 39.08 88.77 40.03L88.66 39.92L88.63 39.90Q89.78 41.81 92.59 42.30L92.63 42.34L92.53 42.24Q93.77 42.52 99.13 42.64Z"/><path fill="#333" d="M21.83 19.65L21.84 19.66L20.29 19.79L20.22 19.71Q17.98 19.84 17.75 21.85L17.70 21.80L17.78 21.89Q17.71 22.61 17.75 23.60L17.66 23.52L17.71 23.56Q17.79 25.55 19.05 26.88L19.07 26.90L18.99 26.82Q20.22 28.13 22.12 27.97L22.10 27.95L22.29 28.14Q24.24 27.88 25.00 26.97L24.95 26.92L24.92 26.89Q26.16 26.15 26.43 23.91L26.42 23.90L26.37 23.85Q26.64 21.60 25.38 20.77L25.45 20.83L25.34 20.73Q24.41 19.87 21.74 19.56ZM27.85 28.87L27.85 28.87L26.66 31.25L26.54 31.14Q23.81 35.91 20.04 39.98L20.13 40.07L20.14 40.08Q18.52 40.25 15.82 41.05L15.75 40.98L15.83 41.06Q21.14 34.75 24.30 29.96L24.17 29.84L24.34 30.00Q23.19 30.53 21.55 30.61L21.63 30.68L21.53 30.59Q18.62 30.83 17.10 28.85L17.12 28.87L16.99 28.74Q15.92 27.29 14.81 22.72L14.66 22.57L14.83 22.74Q14.72 22.17 14.57 21.24L14.66 21.34L14.67 21.35Q14.47 20.36 14.47 19.90L14.41 19.84L14.34 19.78Q14.39 18.04 15.46 17.43L15.41 17.38L15.58 17.55Q16.67 16.66 18.53 16.66L18.50 16.62L18.56 16.68Q21.85 16.78 21.85 16.78L21.80 16.73L21.81 16.73Q23.87 16.66 25.12 16.85L25.27 17.00L25.11 16.84Q27.34 17.21 28.26 17.70L28.16 17.60L28.28 17.72Q29.57 18.41 29.76 20.16L29.83 20.22L29.88 20.28Q29.89 20.51 29.70 23.18L29.53 23.01L29.70 23.19Q29.21 25.21 28.98 26.04L28.99 26.05L29.08 26.14Q28.63 27.48 27.87 28.89ZM29.82 31.33L29.72 31.23L29.71 31.23Q30.80 29.11 31.33 24.81L31.31 24.80L31.27 24.75Q31.50 22.51 31.46 21.63L31.58 21.75L31.58 21.75Q31.56 19.90 30.38 18.99L30.26 18.87L30.04 18.84L29.96 18.76Q29.67 17.97 28.76 17.33L28.83 17.40L28.90 17.47Q26.45 16.31 21.65 16.16L21.82 16.33L21.79 16.30Q20.73 16.19 18.29 16.19L18.37 16.26L18.33 16.22Q16.57 16.21 15.08 16.90L15.19 17.00L15.03 16.85Q13.97 17.73 14.05 19.56L14.11 19.62L14.01 19.52Q14.19 20.42 14.38 22.44L14.42 22.48L14.40 22.46Q15.08 25.16 15.35 26.00L15.38 26.03L15.39 26.04Q15.79 27.74 16.74 29.03L16.73 29.02L16.74 29.03Q17.00 29.36 17.38 29.74L17.40 29.77L17.43 29.80Q17.69 30.24 18.34 31.16L18.40 31.22L18.42 31.24Q19.89 32.60 21.84 32.79L21.86 32.81L21.72 32.68Q19.98 35.51 18.42 37.41L18.36 37.35L14.72 41.70L14.77 41.76Q17.01 40.98 18.64 40.64L18.60 40.60L18.67 40.66Q17.79 41.43 16.23 43.14L16.26 43.17L16.38 43.29Q19.46 42.37 22.58 42.33L22.45 42.20L22.43 42.18Q24.76 39.60 29.10 32.37L29.16 32.42L29.24 32.58L29.13 32.47Q29.33 31.68 29.67 31.18ZM23.72 22.00L23.68 21.96L23.66 21.94Q24.31 21.86 24.77 21.98L24.88 22.09L24.74 21.96Q25.49 22.17 25.87 22.29L25.83 22.24L25.78 22.19Q25.98 22.66 26.06 23.08L26.02 23.04L26.08 23.10Q26.19 23.55 26.07 23.93L25.91 23.76L25.93 23.79Q26.04 25.65 24.86 26.75L24.87 26.76L24.83 26.73Q23.84 27.72 22.21 27.68L22.16 27.64L22.13 27.61Q21.74 27.63 20.21 27.32L20.28 27.39L20.31 27.42Q20.11 26.57 20.11 25.85L20.11 25.84L19.93 25.67Q19.87 25.41 19.87 25.19L19.92 25.24L19.87 25.19Q19.86 22.97 22.14 22.17L22.28 22.31L22.25 22.28Q22.93 22.04 23.77 22.04Z"/><path fill="#222" d="M49.44 39.93L49.30 39.79L49.43 39.92Q47.33 39.73 45.31 39.92L45.33 39.93L45.32 39.93Q46.06 34.76 46.06 29.93L46.04 29.91L45.96 29.83Q46.08 25.04 45.43 19.83L45.35 19.74L45.40 19.79Q40.90 19.48 37.70 17.80L37.53 17.63L36.97 16.05L36.91 15.98Q36.72 15.49 36.11 14.27L36.10 14.26L36.15 14.31Q41.15 16.91 47.16 17.10L47.19 17.13L47.23 17.17Q53.05 17.28 58.49 15.22L58.52 15.25L58.56 15.29Q57.74 16.60 57.09 18.43L57.20 18.54L57.17 18.50Q53.51 19.76 49.25 19.95L49.24 19.94L49.23 19.92Q49.02 24.93 49.02 29.88L49.00 29.86L49.12 29.98Q49.12 34.93 49.42 39.92ZM59.11 14.47L59.13 14.49L59.09 14.45Q53.35 16.81 47.14 16.62L47.05 16.54L47.07 16.55Q40.47 16.43 35.37 13.46L35.46 13.54L35.35 13.43Q36.13 14.74 37.42 18.02L37.46 18.06L37.46 18.06Q38.04 18.29 39.29 18.86L39.38 18.95L39.33 18.90Q39.70 19.73 40.04 21.25L39.87 21.07L39.86 21.06Q42.27 22.03 45.32 22.26L45.32 22.26L45.23 22.17Q45.70 25.95 45.70 29.72L45.56 29.59L45.72 29.74Q45.61 35.01 44.82 40.37L44.96 40.52L44.85 40.41Q46.49 40.26 47.03 40.26L47.09 40.33L47.16 40.40Q47.16 40.70 47.11 41.37L46.94 41.20L47.06 41.32Q46.94 41.93 46.94 42.27L47.01 42.34L46.98 42.31Q48.23 42.30 49.75 42.38L49.63 42.26L49.58 42.20Q50.59 42.35 52.42 42.50L52.45 42.52L52.30 42.38Q51.23 37.61 51.11 32.43L51.08 32.40L51.08 32.40Q50.92 27.06 51.45 22.15L51.39 22.09L51.48 22.18Q55.37 21.57 58.52 20.35L58.54 20.37L58.55 20.38Q59.32 18.07 60.35 16.01L60.18 15.84L60.29 15.95Q58.99 16.67 58.19 16.98L58.17 16.95L58.13 16.91Q58.51 15.58 59.08 14.43Z"/></svg>'
    base_path = os.path.join(".", "recaptchas")
    if not os.path.exists(base_path):
        os.mkdir(base_path)
    svg_file = os.path.join(base_path, "{}.svg".format(str(uuid.uuid4())))
    png_file = os.path.join(base_path, "{}.png".format(str(uuid.uuid4())))
    with open(svg_file, 'w', encoding="utf-8") as file:
        file.write(svg_str)
    drawing = svg2rlg(svg_file)
    os.remove(svg_file)
    renderPM.drawToFile(drawing, png_file, fmt="PNG")
    with open(png_file, 'rb') as file:
        png_bytes = file.read()
    os.remove(png_file)
    return png_bytes
